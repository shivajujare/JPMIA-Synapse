{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"workspaceName": {
			"type": "string",
			"metadata": "Workspace name",
			"defaultValue": "jpmia-synapse-analytics"
		},
		"jpmia-synapse-analytics-WorkspaceDefaultSqlServer_connectionString": {
			"type": "secureString",
			"metadata": "Secure string for 'connectionString' of 'jpmia-synapse-analytics-WorkspaceDefaultSqlServer'",
			"defaultValue": "Integrated Security=False;Encrypt=True;Connection Timeout=30;Data Source=tcp:jpmia-synapse-analytics.sql.azuresynapse.net,1433;Initial Catalog=@{linkedService().DBName}"
		},
		"jpmia-synapse-analytics-WorkspaceDefaultStorage_properties_typeProperties_url": {
			"type": "string",
			"defaultValue": "https://adlsjpmia.dfs.core.windows.net"
		},
		"kvs_jpmia_properties_typeProperties_baseUrl": {
			"type": "string",
			"defaultValue": "https://kv-jpmia-dev.vault.azure.net/"
		}
	},
	"variables": {
		"workspaceId": "[concat('Microsoft.Synapse/workspaces/', parameters('workspaceName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('workspaceName'), '/jpmia-synapse-analytics-WorkspaceDefaultSqlServer')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"parameters": {
					"DBName": {
						"type": "String"
					}
				},
				"annotations": [],
				"type": "AzureSqlDW",
				"typeProperties": {
					"connectionString": "[parameters('jpmia-synapse-analytics-WorkspaceDefaultSqlServer_connectionString')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/jpmia-synapse-analytics-WorkspaceDefaultStorage')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "AzureBlobFS",
				"typeProperties": {
					"url": "[parameters('jpmia-synapse-analytics-WorkspaceDefaultStorage_properties_typeProperties_url')]"
				},
				"connectVia": {
					"referenceName": "AutoResolveIntegrationRuntime",
					"type": "IntegrationRuntimeReference"
				}
			},
			"dependsOn": [
				"[concat(variables('workspaceId'), '/integrationRuntimes/AutoResolveIntegrationRuntime')]"
			]
		},
		{
			"name": "[concat(parameters('workspaceName'), '/kvs_jpmia')]",
			"type": "Microsoft.Synapse/workspaces/linkedServices",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"annotations": [],
				"type": "AzureKeyVault",
				"typeProperties": {
					"baseUrl": "[parameters('kvs_jpmia_properties_typeProperties_baseUrl')]"
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/AutoResolveIntegrationRuntime')]",
			"type": "Microsoft.Synapse/workspaces/integrationRuntimes",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"type": "Managed",
				"typeProperties": {
					"computeProperties": {
						"location": "AutoResolve",
						"dataFlowProperties": {
							"computeType": "General",
							"coreCount": 8,
							"timeToLive": 0
						}
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/WorkspaceSystemIdentity')]",
			"type": "Microsoft.Synapse/workspaces/credentials",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"type": "ManagedIdentity",
				"typeProperties": {}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/ext_tables_uv')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "create MASTER KEY ENCRYPTION BY PASSWORD = 'jpmia#2188';\n\ndrop CREDENTIAL uv_sas_token;\ncreate DATABASE SCOPED CREDENTIAL uv_sastoken WITH IDENTITY = 'SHARED ACCESS SIGNATURE',\nSECRET = 'sv=2022-11-02&ss=b&srt=sco&sp=rwdlacyx&se=2024-03-20T11:40:06Z&st=2024-03-20T03:40:06Z&spr=https&sig=9yih8uXfylDXICIB9hRtjn%2FjDVmVSSfB9%2FBlYCR0g0Y%3D';\n\n\ncreate EXTERNAL DATA SOURCE ext_usage_view_\nwith (\n    LOCATION='https://adlsjpmia.blob.core.windows.net/jpmia/usage_view/',\n    CREDENTIAL = uv_sastoken\n);\n\ncreate EXTERNAL DATA SOURCE ext_biz_view_\nwith (\n    LOCATION='https://adlsjpmia.blob.core.windows.net/jpmia/biz_view/',\n    CREDENTIAL = uv_sastoken\n);\n\nDROP EXTERNAL TABLE jpmia.DimCompanies;\nCREATE EXTERNAL FILE FORMAT uv_delta_format\nWITH (\n    FORMAT_TYPE = PARQUET,\n    DATA_COMPRESSION = 'org.apache.hadoop.io.compress.SnappyCodec' -- Optional: specify compression codec\n);\n\n\nCREATE EXTERNAL table jpmia.DimCompanies\n(\n    company_id bigint,\n            name NVARCHAR(200),\n           description NVARCHAR(MAX),\n           company_size int,\n           formatted_company_size NVARCHAR(50),\n           state NVARCHAR(100),\n           country NVARCHAR(100),\n           city NVARCHAR(100),\n           zip_code NVARCHAR(100),\n           address NVARCHAR(3000),\n           url NVARCHAR(1000),\n           ingest_date date\n)\nWITH(\n    LOCATION = 'DimCompanies',\n    DATA_SOURCE = ext_usage_view_,\n    FILE_FORMAT = uv_delta_format\n)\ngo;\n\nselect TOP 100 ingest_date from jpmia.DimCompanies;\n\n------------\n\nCREATE EXTERNAL table jpmia.DimCompanyIndustries\n(\n    company_id bigint,\n  industries NVARCHAR(1000),\n  ingest_date date\n)\nWITH(\n    LOCATION = 'DimCompanyIndustries',\n    DATA_SOURCE = ext_usage_view_,\n    FILE_FORMAT = uv_delta_format\n)\ngo;\n\nselect top 10 * from jpmia.DimCompanyIndustries;\n\n----------------\n\nCREATE EXTERNAL table jpmia.DimCompanySpecialities(\n  company_id bigint,\n  specialities NVARCHAR(3000),\n  ingest_date date\n)\nWITH(\n    LOCATION = 'DimCompanySpecialities',\n    DATA_SOURCE = ext_usage_view_,\n    FILE_FORMAT = uv_delta_format\n)\ngo;\n\nSELECT top 10 * from jpmia.DimCompanySpecialities;\n\n-----------------\n\nCREATE EXTERNAL table jpmia.DimJobBenefits(\n  job_id bigint,\n  inferred VARCHAR(10),\n  type VARCHAR(2000),\n  ingest_date date\n  )\nWITH(\n    LOCATION = 'DimJobBenefits',\n    DATA_SOURCE = ext_usage_view_,\n    FILE_FORMAT = uv_delta_format\n)\ngo;\n\nselect * from jpmia.DimJobBenefits;\n\n------------------\n\n\n\nCREATE EXTERNAL table jpmia.DimJobSkills(\n  job_id\tbigint,\n  skill_abr NVARCHAR(1000),\n  skill_name NVARCHAR(2000),\n  ingest_date date\n  )\nWITH(\n    LOCATION = 'DimJobSkills',\n    DATA_SOURCE = ext_usage_view_,\n    FILE_FORMAT = uv_delta_format\n)\ngo;\n\nselect top 10 * from jpmia.DimJobSkills;\n\n-------------\n\nCREATE EXTERNAL table jpmia.FactCompanyEmployeeGrowth\n(\n  company_id bigint,\n  employee_count bigint,\n  follower_count bigint,\n  time_recorded NVARCHAR(1000),\n  date_time_recorded DATETIME2,\n  date_recorded date,\n  total_employees_as_of_now bigint,\n  total_followers_as_of_now bigint,\n  ingest_date date\n  )\nWITH(\n    LOCATION = 'FactCompanyEmployeeGrowth',\n    DATA_SOURCE = ext_usage_view_,\n    FILE_FORMAT = uv_delta_format\n)\ngo;\n\nSELECT * from jpmia.FactCompanyEmployeeGrowth;\n\n-------------\ndrop EXTERNAL TABLE jpmia.DimJobIndustries;\nCREATE EXTERNAL table jpmia.DimJobIndustries(\n  job_id\tbigint,\n  industry_id bigint,\n  industry_name NVARCHAR(1000),\n  ingest_date date\n  )\nWITH(\n    LOCATION = 'DimJobIndustries',\n    DATA_SOURCE = ext_usage_view_,\n    FILE_FORMAT = uv_delta_format\n)\ngo;\n\nSELECT * from jpmia.DimJobIndustries;\n\n--------\n\nCREATE EXTERNAL table jpmia.DimJobSalaries\n(\n    salary_id bigint,\n  job_id bigint,\n  max_salary float,\n  med_salary float,\n  min_salary float,\n  pay_period NVARCHAR(100),\n  currency NVARCHAR(10),\n  compensation_type NVARCHAR(100),\n  ingest_date date\n)\nWITH(\n    LOCATION = 'job_salaries',\n    DATA_SOURCE = ext_biz_view_,\n    FILE_FORMAT=uv_delta_format\n);\n\nselect top 10 * from jpmia.DimJobSalaries;\n\n-------\n\nCREATE EXTERNAL table jpmia.FactJobPostings\n(\n    job_id bigint, \n  company_id bigint,\t\n  locations NVARCHAR(500),\t\n  applies int,\t\n  original_listed_time NVARCHAR(100),\t\n  remote_allowed NVARCHAR(10),\t\n  views int,\t\n  job_posting_url\tNVARCHAR(1000), \n  application_url NVARCHAR(1000),\t\n  application_type NVARCHAR(1000),\t\n  expiry NVARCHAR(100),\t\n  closed_time NVARCHAR(100),\t\n  experience_level NVARCHAR(100),\t\n  listed_time NVARCHAR(100),\t\n  posting_domain NVARCHAR(100),\t\n  sponsored NVARCHAR(100),\t\n  work_type NVARCHAR(100),\t\n  scraped NVARCHAR(100),\n  ingest_date date\n)\nWITH(\n    LOCATION = 'job_postings',\n    DATA_SOURCE = ext_biz_view_,\n    FILE_FORMAT=uv_delta_format\n);\n\nselect top 10 * from jpmia.FactJobPostings;\n\nSELECT * from sys.tables;",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "Market-insight-analytics",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/schema')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "CREATE SCHEMA jpmia;\n\nselect top 100 * from jpmia.vw_job_detail;",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "Market-insight-analytics",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/vw_Company_detail')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "create view jpmia.vw_Company_details\nAS\nselect \n    comp.company_id,\n    comp.name,\n    comp.description,\n    comp.company_size ,\n    comp.formatted_company_size,\n    comp.state ,\n    comp.country ,\n    comp.city ,\n    comp.zip_code ,\n    comp.address,\n    comp.url,\n    comp_ind.industries,\n    comp_spl.specialities,\n    femp.total_employees_as_of_now as number_of_employees,\n    femp.total_followers_as_of_now as number_of_followers\nfrom jpmia.DimCompanies comp\nleft join jpmia.DimCompanyIndustries comp_ind\n    on comp.company_id = comp_ind.company_id\nleft join jpmia.DimCompanySpecialities comp_spl\n    on comp.company_id = comp_spl.company_id\nleft join jpmia.FactCompanyEmployeeGrowth femp\n    on comp.company_id = femp.company_id\n;",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "Market-insight-analytics",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('workspaceName'), '/vw_job_detail')]",
			"type": "Microsoft.Synapse/workspaces/sqlscripts",
			"apiVersion": "2019-06-01-preview",
			"properties": {
				"content": {
					"query": "create view jpmia.vw_Job_Detail \nas\nwith agg_skills as(\n    select job_id,\n            STRING_AGG(skill_name, ',') as skills\n    from jpmia.DimJobSkills skills\n    GROUP by job_id\n),\nagg_industries as (\n    select job_id, STRING_AGG(industry_name, ',') as industries\n    from jpmia.DimJobIndustries\n    group by job_id\n),\nsalaries as (\n    select  job_id,\n            case when pay_period = 'HOURLY' then (max_salary*8)*365 \n                 when pay_period = 'YEARLY' then max_salary\n                 when pay_period = 'MONTHLY' then (max_salary*12)\n                 when pay_period = 'WEEKLY' then (max_salary*52)\n                 when pay_period = 'ONCE' then max_salary\n            end as Max_salary_per_annum,\n            case when pay_period = 'HOURLY' then (min_salary*8)*365 \n                 when pay_period = 'YEARLY' then min_salary\n                 when pay_period = 'MONTHLY' then (min_salary*12)\n                 when pay_period = 'WEEKLY' then (min_salary*52)\n                 when pay_period = 'ONCE' then min_salary\n            end as Min_salary_per_annum,\n            case when pay_period = 'HOURLY' then (med_salary*8)*365 \n                 when pay_period = 'YEARLY' then med_salary\n                 when pay_period = 'MONTHLY' then (med_salary*12)\n                 when pay_period = 'WEEKLY' then (med_salary*52)\n                 when pay_period = 'ONCE' then med_salary\n            end as Med_salary_per_annum,\n            currency,\n            compensation_type\n    from jpmia.DimJobSalaries\n)\nselect top 100 \nbenef.job_id,\nbenef.type as benefits,\nbenef.inferred,\nskills.skills as required_skills,\nindus.industries as industries,\nsal.Max_salary_per_annum,\nsal.Min_salary_per_annum,\nsal.Med_salary_per_annum,\nsal.currency,\nsal.compensation_type\nfrom jpmia.DimJobBenefits benef\nleft join agg_skills skills\n    on benef.job_id = skills.job_id\nleft join agg_industries indus\n    on indus.job_id = benef.job_id\nleft join salaries sal \n    on sal.job_id = benef.job_id\n;",
					"metadata": {
						"language": "sql"
					},
					"currentConnection": {
						"databaseName": "Market-insight-analytics",
						"poolName": "Built-in"
					},
					"resultLimit": 5000
				},
				"type": "SqlQuery"
			},
			"dependsOn": []
		}
	]
}